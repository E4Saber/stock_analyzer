# AKShare量化分析平台

基于AKShare和Streamlit开发的量化分析平台，提供市场概览、个股分析、量化策略回测和热点资讯等功能。

## 功能特点

- **市场概览**: 展示大盘指数、行业板块、热点资讯等全景市场数据
- **个股分析**: 提供个股K线图、技术指标、交易信号等全面分析
- **量化策略**: 支持均线交叉、MACD、布林带、RSI等经典量化策略的回测
- **热点资讯**: 收集整理市场最新动态和热点资讯

## 安装和使用

1. 安装依赖:
```bash
pip install -r requirements.txt
```

2. 运行应用:
```bash
streamlit run app.py
```

## 项目结构

采用模块化设计，各模块职责明确，便于扩展和维护:

- `data_loader.py`: 数据加载模块
- `technical_analysis.py`: 技术分析模块
- `visualization.py`: 数据可视化模块
- `market_overview.py`: 市场概览模块
- `stock_analyzer.py`: 个股分析模块
- `strategy.py`: 量化策略模块
- `backtest.py`: 回测引擎模块
- `news_collector.py`: 新闻收集模块

## 注意事项

- 本项目仅供学习研究使用，不构成任何投资建议
- 数据来源于AKShare，可能存在延迟或不准确
- 策略回测结果仅供参考，实际交易可能有所不同

# AKShare量化分析平台 - 模块化设计

## 项目结构
```
akshare_quant_app/
├── app.py                   # 主应用入口
├── requirements.txt         # 项目依赖
├── README.md                # 项目说明
└── modules/                 # 模块目录
    ├── __init__.py          # 模块初始化文件
    ├── data_loader.py       # 数据加载模块
    ├── technical_analysis.py # 技术分析模块
    ├── visualization.py     # 数据可视化模块
    ├── market_overview.py   # 市场概览模块
    ├── stock_analyzer.py    # 个股分析模块
    ├── strategy.py          # 量化策略模块
    ├── backtest.py          # 回测引擎模块
    └── news_collector.py    # 新闻收集模块
```

# InStock: 股票市场分析平台详细分析

## 核心组件

### 1. 数据爬取模块

系统拥有一套完整的数据爬取架构，从多个来源获取实时和历史股票市场数据：

- `stock_hist_em.py`: 负责从东方财富获取股票的历史K线数据，支持日线、周线、月线以及分钟级别数据，还提供了前复权、后复权和不复权的选项。
  
- `fund_etf_em.py`: 专门爬取ETF相关数据，包括ETF实时行情、历史数据和分钟级别数据，支持详细的ETF交易信息查询。

- `stock_fund_em.py`: 获取资金流向数据，包括个股资金流入流出、板块资金流动、大单小单分析等，可以分析市场的热点资金动向。

- `stock_fhps_em.py`: 爬取上市公司的分红派息信息，包括送转股份、现金分红比例、股息率等财务数据。

- `stock_dzjy_em.py`: 获取大宗交易数据，包括每日统计、市场统计、活跃A股统计等多种维度的大宗交易数据。

- `stock_lhb_em.py` 和 `stock_lhb_sina.py`: 分别从东方财富和新浪财经获取龙虎榜数据，包括每日上榜明细、机构买卖明细、活跃营业部统计等。

- `stock_selection.py`: 实现了东方财富网选股器的数据抓取，可以根据各种条件筛选股票。

- `stock_cpbd.py`: 获取个股的操盘必读数据，包括基本面、技术面等综合信息。

- `trade_date_hist.py`: 爬取股票市场的交易日历数据，用于确定哪些日期是交易日。

### 2. 技术分析和指标计算模块

`calculate_indicator.py`模块是系统的核心技术分析引擎，使用TA-Lib库实现了几十种技术指标的计算，包括：

- **价格趋势指标**：
  - MA (移动平均线): 多种周期(5日、10日、20日、30日、60日、200日等)
  - MACD (平滑异同移动平均线): 包含DIF、MACD和柱状图
  - BOLL (布林带): 上轨、中轨、下轨
  - ENE (轨道线): 上轨、中轨、下轨

- **震荡指标**：
  - KDJ (随机指标): K、D、J三条线
  - RSI (相对强弱指标): 6、12、14、24日多周期
  - STOCHRSI (随机相对强弱指标): K和D值
  - CCI (顺势指标): 普通周期和84日周期
  - W&R (威廉指标): 6、10、14日周期

- **特殊技术指标**：
  - TRIX (三重指数平滑移动平均指标)
  - TEMA (三重指数移动平均指标)
  - PPO (价格震荡百分比指标)
  - DMA (平行线差指标)
  - BIAS (乖离率指标): 6、12、24日周期
  - EMV (简易波动指标)
  - VWMA (成交量加权平均指标)
  - VHF (十字过滤线)

- **成交量指标**：
  - VOL (成交量): 原始成交量以及5日、10日均量
  - OBV (能量潮指标)
  - VR (成交量比率)
  - MFI (资金流量指标)
  - FI (劲道指数): 2日和13日周期

- **动量和趋势指标**：
  - DMI (动向指数): 包含PDI、MDI、DX、ADX和ADXR
  - RVI (相对离散指数)
  - PSY (心理线指标)
  - ROC (变动率)
  - ATR (均幅指标)
  - SUPERTREND (超级趋势指标)
  - WT (Wave Trend指标): WT1和WT2

- **特殊分析工具**：
  - BRAR (人气意愿指标): BR和AR两个指标
  - CR (价格动量指标)
  - DPO (区间震荡线)
  - SAR (抛物线转向指标)

每个指标都有详细的计算逻辑和参数设置，可以为股票价格走势提供多维度的技术分析视角。

### 3. K线形态识别模块

`pattern_recognitions.py`模块实现了股票K线形态的识别，基于TA-Lib库提供的形态识别算法，能够识别超过60种不同的K线形态，包括：

- **反转形态**：
  - 锤头线 (Hammer)
  - 上吊线 (Hanging Man)
  - 乌云盖顶 (Dark Cloud Cover)
  - 吞噬模式 (Engulfing Pattern)
  - 晨星 (Morning Star) 和 暮星 (Evening Star)
  - 十字星 (Doji Star)
  - 刺透形态 (Piercing Pattern)

- **持续形态**：
  - 三白兵 (Three White Soldiers)
  - 三只乌鸦 (Three Black Crows)
  - 三线打击 (Three Line Strike)
  - 上升/下降三法 (Rising/Falling Three Methods)

- **其他经典形态**：
  - 十字 (Doji)
  - 长脚十字 (Long Legged Doji)
  - 墓碑十字 (Gravestone Doji)
  - 蜻蜓十字 (Dragonfly Doji)
  - 纺锤 (Spinning Top)
  - 母子线 (Harami Pattern)
  - 十字孕线 (Harami Cross Pattern)

形态识别结果可以直接应用于交易策略中，也可以在K线图上进行可视化展示，帮助投资者快速识别重要的技术形态。

### 4. 交易策略模块

系统实现了多种交易策略，每种策略都有完整的逻辑实现和参数设置：

- `enter.py`: 实现了放量上涨策略，关注当日比前一天上涨小于2%或收盘价小于开盘价、当日成交额不低于2亿、当日成交量/5日平均成交量>=2的股票。

- `turtle_trade.py`: 实现海龟交易法则，当收盘价大于等于最近60日最高收盘价时发出买入信号。

- `backtrace_ma250.py`: 年线回踩策略，寻找由年线(250日均线)以下向上突破，然后在年线上方运行一段时间后回踩到年线附近的股票。

- `breakthrough_platform.py`: 平台突破策略，寻找60日内某日收盘价>=60日均线>开盘价，且放量上涨，并且之前时间任意一天收盘价与60日均线偏离在-5%~20%之间的股票。

- `climax_limitdown.py`: 放量跌停策略，关注跌幅大于9.5%、成交额不低于2亿、成交量至少是5日平均成交量4倍的股票。

- `high_tight_flag.py`: 高而窄的旗形策略，寻找当日收盘价/之前24~10日的最低价>=1.9，且之前24~10日必须连续两天涨幅大于等于9.5%的股票。

- `keep_increasing.py`: 均线多头策略，寻找30日前的30日均线<20日前的30日均线<10日前的30日均线<当日的30日均线，且当日的30日均线/30日前的30日均线>1.2的股票。

- `low_atr.py`: 低ATR成长策略，关注最近10个交易日的最高收盘价必须比最近10个交易日的最低收盘价高1.1倍的股票。

- `low_backtrace_increase.py`: 无大幅回撤策略，寻找当日收盘价比60日前的收盘价的涨幅小于0.6，且最近60日没有单日跌幅超7%、高开低走7%、两日累计跌幅10%、两日高开低走累计10%的股票。

- `parking_apron.py`: 停机坪策略，寻找最近15日有涨幅大于9.5%且是放量上涨，紧接的几个交易日高开且收盘上涨，但涨幅维持在较小范围内的股票。

这些策略模块都有独立的检查函数，可以对股票历史数据进行分析，并判断是否符合策略要求，为投资决策提供参考依据。

### 5. 可视化模块

`visualization.py`模块使用Bokeh库实现了强大的交互式可视化功能：

- **K线图绘制**：支持日K、周K、月K多种时间周期的蜡烛图绘制，包括开盘价、收盘价、最高价、最低价的完整K线信息。

- **技术指标叠加**：可以在K线图上叠加各种技术指标，包括移动平均线、MACD、KDJ、RSI等，支持指标的显示/隐藏控制。

- **成交量图表**：K线图下方展示对应的成交量柱状图，并可叠加成交量移动平均线。

- **筹码分布分析**：使用`cyq.js`和`cyq.py`实现了筹码分布的可视化，展示不同价格区间的筹码集中度，帮助分析支撑位和阻力位。

- **形态标记**：在K线图上标记已识别的K线形态，如锤头线、十字星等，并支持通过复选框控制形态标记的显示/隐藏。

- **技术指标卡片**：以选项卡形式展示多种技术指标的详细图表，每个指标都有详细解读和参考链接。

- **交互控件**：包括平移、缩放、选择、保存等交互功能，以及十字光标辅助定位价格和日期。

- **数据展示**：展示股票的基本信息、筹码分布数据、获利比例等统计信息。

可视化模块的设计注重用户体验和信息展示的完整性，为用户提供直观、详细的股票技术分析视图。

### 6. 数据库结构

系统设计了完善的数据库结构，通过`tablestructure.py`定义了多个表结构：

- `TABLE_CN_STOCK_ATTENTION`: 用户关注的股票
- `TABLE_CN_ETF_SPOT`: ETF每日数据
- `TABLE_CN_STOCK_SPOT`: 股票每日数据
- `TABLE_CN_STOCK_FUND_FLOW`: 股票资金流向数据
- `TABLE_CN_STOCK_FUND_FLOW_INDUSTRY`: 行业资金流向数据
- `TABLE_CN_STOCK_FUND_FLOW_CONCEPT`: 概念资金流向数据
- `TABLE_CN_STOCK_BONUS`: 股票分红配送数据
- `TABLE_CN_STOCK_TOP`: 股票龙虎榜数据
- `TABLE_CN_STOCK_BLOCKTRADE`: 股票大宗交易数据
- `TABLE_CN_STOCK_INDICATORS`: 股票技术指标数据
- `TABLE_CN_STOCK_KLINE_PATTERN`: 股票K线形态数据
- `TABLE_CN_STOCK_SELECTION`: 综合选股数据

每个表都定义了详细的字段结构，包括字段名、数据类型、中文描述和显示尺寸等信息，为数据存储和查询提供了标准化的结构定义。

## 核心功能实现

### 1. 筹码分布分析

`cyq.py`和`cyq.js`模块实现了筹码分布的计算和可视化：

- 分析股票在不同价格区间的筹码分布情况
- 计算平均成本线、获利比例、筹码集中度等关键指标
- 分析不同比例（如70%、90%）的筹码所在的价格区间
- 将筹码分布可视化为区域图，直观展示多空力量对比
- 通过不同颜色区分获利筹码和套牢筹码

筹码分布分析是该系统的一个亮点功能，通过模拟股票历史交易过程中的筹码堆积情况，帮助分析师判断潜在的支撑位和阻力位，以及市场参与者的整体情绪状态。

### 2. 资金流向分析

系统通过`stock_fund_em.py`模块实现了多维度的资金流向分析：

- **个股资金流向**：分析主力资金、超大单、大单、中单、小单的净流入情况，判断资金动向
- **行业资金流向**：分析不同行业板块的资金流入流出情况，识别热点板块
- **概念资金流向**：分析概念板块的资金流动，把握市场主题投资机会
- **时间维度分析**：支持今日、3日、5日、10日等多个时间周期的资金流向分析
- **龙虎榜资金分析**：结合`stock_lhb_em.py`模块，分析龙虎榜上的机构资金动向

资金流向分析功能可以帮助投资者了解市场的资金动向，识别主力资金的关注焦点，发现潜在的投资机会。

### 3. 数据缓存和性能优化

系统实现了多种性能优化机制：

- **单例模式**：通过`singleton_type.py`中的元类实现单例模式，用于管理共享资源，如交易日历数据、股票基本数据等。

- **数据缓存**：在`stockfetch.py`中实现了历史数据的缓存机制，将常用的历史数据保存在本地文件系统中，减少网络请求，提高数据访问效率。

- **并行处理**：使用`concurrent.futures`模块实现并行数据处理，特别是在获取多只股票的历史数据时，通过多线程显著提高效率。

- **增量更新**：设计了增量更新机制，只获取和处理新增的数据，避免重复处理已有数据。

- **数据压缩**：使用gzip压缩方式存储缓存数据，减少存储空间占用。

这些优化手段大大提升了系统的运行效率，特别是在处理大量历史数据和实时数据的场景中。

### 4. Web界面组件

`web_module_data.py`和`singleton_stock_web_module_data.py`模块定义了Web界面的数据组件：

- 支持查询和编辑两种操作模式
- 为每个功能模块定义了图标、名称、表名和字段信息
- 支持表格数据的排序和筛选
- 实现了表格字段的显示控制和格式设置
- 通过单例模式管理Web模块数据，提高性能

这些组件为系统提供了统一的Web界面数据访问接口，便于前端展示和交互。

## 技术架构

系统采用模块化、分层架构设计：

1. **数据获取层**：负责从各种数据源获取原始数据，包括网络爬虫和数据接口封装。

2. **数据处理层**：负责数据清洗、转换和计算，实现各种技术指标和分析模型。

3. **策略逻辑层**：实现各种交易策略和决策逻辑，基于处理后的数据生成交易信号。

4. **数据存储层**：定义数据库结构和访问接口，实现数据的持久化存储。

5. **可视化展示层**：实现数据的图形化展示和交互功能，为用户提供直观的分析界面。

6. **Web接口层**：提供Web服务和API，支持用户通过浏览器访问系统功能。

这种分层设计使系统具有良好的可维护性和可扩展性，各层之间通过清晰的接口进行交互，便于独立开发和测试。

## 总结

InStock是一个功能全面、架构清晰的股票市场分析平台，集成了数据获取、技术分析、策略研究、可视化展示等多种功能，为投资者提供了强大的决策支持工具。系统的模块化设计和性能优化措施使其能够高效处理大量市场数据，而丰富的技术指标和交易策略实现又为投资分析提供了多样化的视角。通过这个平台，投资者可以更全面、深入地了解市场动态，发现潜在的投资机会。